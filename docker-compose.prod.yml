version: '3.8'
services:
  frontend:
    image: ${CI_REGISTRY_IMAGE}/frontend:${CI_COMMIT_SHA}
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname==ip-10-0-1-166
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
    networks:
      - myapp_app-network
    environment:
      - PORT=4000
      - REACT_APP_API_URL=/api  # ← Правильно для app.medicalwaste.kz
      - NODE_ENV=production
      - REACT_APP_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}

  backend:
    image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHA}
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname==ip-10-0-1-166
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
    networks:
      - myapp_app-network
    environment:
      - PORT=5000
      - MONGODB_URI=mongodb://myapp_mongodb:27017/trashbin_db
      - NODE_ENV=production
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=https://app.medicalwaste.kz/auth/google/callback  # ← Обновите
      - FRONTEND_URL=https://app.medicalwaste.kz  # ← Новая переменная
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - BCRYPT_ROUNDS=12
      # CORS origins для backend (если нужно)
      - ALLOWED_ORIGINS=https://app.medicalwaste.kz,https://medicalwaste.kz,capacitor://localhost

  mongodb:
    image: mongo:4.4
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname==ip-10-0-1-166
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
    volumes:
      - mongodb_data:/data/db
    networks:
      - myapp_app-network

  nginx:
    image: registry.gitlab.com/anuar021/trashbin/nginx:latest
    deploy:
      replicas: 1
      placement: # ← ADD THIS
        constraints: # ← ADD THIS
          - node.role == manager           # ← ADD THIS
    ports: [ "80:8080", "443:8443" ]
    volumes: [ "/etc/letsencrypt:/etc/letsencrypt:ro" ]
    networks: [ myapp_app-network ]
    environment:
      - FRONTEND_HOST=myapp_frontend
      - BACKEND_HOST=myapp_backend
      - SERVER_NAME=app.medicalwaste.kz

networks:
  myapp_app-network:
    external: true

volumes:
  mongodb_data:
