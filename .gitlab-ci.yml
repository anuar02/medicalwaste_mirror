stages:
  - build
  - deploy

services:
  - docker:20.10.16-dind

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

# -----------------------------
# BUILD FRONTEND
# -----------------------------
build-frontend:
  stage: build
  image: docker:20.10.16
  tags:
    - swarm
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

    - mkdir -p temp

    - |
      cat > temp/server.js << 'EOF'
      const express = require("express");
      const path = require("path");
      const app = express();
      const PORT = process.env.PORT || 4000;

      app.get("/health", (_, res) => res.status(200).send("OK"));
      app.use(express.static(path.join(__dirname, "build")));
      app.get("*", (_, res) => res.sendFile(path.join(__dirname, "build", "index.html")));

      app.listen(PORT, "0.0.0.0", () => {
        console.log(`Frontend running on ${PORT}`);
      });
      EOF

    - |
      cat > temp/Dockerfile.frontend << 'EOF'
      FROM node:18-alpine AS build
      WORKDIR /app
      COPY package*.json ./
      RUN if [ -f package-lock.json ]; then npm ci; else npm install; fi
      COPY . .
      ARG REACT_APP_GOOGLE_CLIENT_ID
      ARG REACT_APP_API_URL
      ENV REACT_APP_GOOGLE_CLIENT_ID=$REACT_APP_GOOGLE_CLIENT_ID
      ENV REACT_APP_API_URL=$REACT_APP_API_URL
      ENV CI=false
      RUN npm run build

      FROM node:18-alpine
      WORKDIR /app
      COPY --from=build /app/build ./build
      COPY server.js .
      RUN npm init -y && npm install express@4.18.2
      EXPOSE 4000
      CMD ["node", "server.js"]
      EOF

    - mkdir -p temp/frontend
    - cp -r frontend/* temp/frontend/
    - cp temp/server.js temp/frontend/
    - cd temp/frontend

    - docker build \
      --build-arg REACT_APP_GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
      --build-arg REACT_APP_API_URL="/api" \
      -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA \
      -f ../Dockerfile.frontend .

    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/frontend:latest
    - docker push $CI_REGISTRY_IMAGE/frontend:latest

# -----------------------------
# BUILD BACKEND
# -----------------------------
build-backend:
  stage: build
  image: docker:20.10.16
  tags:
    - swarm
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

    - mkdir -p temp
    - |
      cat > temp/Dockerfile.backend << 'EOF'
      FROM node:18-alpine
      WORKDIR /app
      COPY package*.json ./
      RUN npm ci --only=production || npm install --production
      COPY . .
      EXPOSE 5000
      CMD ["node", "server.js"]
      EOF

    - mkdir -p temp/backend
    - cp -r backend/* temp/backend/
    - cd temp/backend

    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA -f ../Dockerfile.backend .
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/backend:latest
    - docker push $CI_REGISTRY_IMAGE/backend:latest

# -----------------------------
# BUILD NGINX
# -----------------------------
build-nginx:
  stage: build
  image: docker:20.10.16
  tags:
    - swarm
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

    - mkdir -p temp/nginx

    - cp nginx/* temp/nginx/ || true
    - cd temp/nginx

    - docker build -t $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/nginx:latest
    - docker push $CI_REGISTRY_IMAGE/nginx:latest

# -----------------------------
# DEPLOY (SWARM)
# -----------------------------
deploy:
  stage: deploy
  image: docker:20.10.16
  tags:
    - swarm
  only:
    - main
  environment:
    name: production
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker stack deploy --with-registry-auth -c docker-compose.prod.yml myapp
    - sleep 15
    - docker service ls
