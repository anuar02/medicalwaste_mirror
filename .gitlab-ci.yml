deploy:
  stage: deploy
  image: alpine:latest
  variables:
    # Your actual Swarm manager public IP
    SWARM_MANAGER: "51.20.79.185"
    SSH_USER: "ubuntu"
  before_script:
    # Set up SSH for connecting to the Swarm manager
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - |
      cat > docker-compose.prod.yml << EOF
      version: '3.8'
      services:
        frontend:
          image: ${CI_REGISTRY_IMAGE}/frontend:${CI_COMMIT_SHA}
          deploy:
            replicas: 1
            placement:
              constraints:
                - node.hostname==ip-10-0-1-166
            restart_policy:
              condition: any
              delay: 5s
              max_attempts: 5
          networks:
            - myapp_app-network
          environment:
            - PORT=4000
            - REACT_APP_API_URL=/api
            - NODE_ENV=production
      
        backend:
          image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHA}
          deploy:
            replicas: 1
            placement:
              constraints:
                - node.hostname==ip-10-0-1-166
            restart_policy:
              condition: any
              delay: 5s
              max_attempts: 5
          networks:
            - myapp_app-network
          environment:
            - PORT=5000
            - MONGODB_URI=mongodb://myapp_mongodb:27017/trashbin_db
            - NODE_ENV=production
      
        nginx:
          image: ${CI_REGISTRY_IMAGE}/nginx:${CI_COMMIT_SHA}
          deploy:
            replicas: 1
            placement:
              constraints:
                - node.hostname==ip-10-0-1-166
            restart_policy:
              condition: any
              delay: 5s
              max_attempts: 5
          ports:
            - "80:8080"
          networks:
            - myapp_app-network
          environment:
            - FRONTEND_HOST=myapp_frontend
            - BACKEND_HOST=myapp_backend

      networks:
        myapp_app-network:
          external: true
      EOF
    - |
      cat > deploy.sh << 'EOF'
      #!/bin/sh
      set -e
      
      # Login to registry
      echo "Logging in to registry..."
      echo $2 | docker login --username $1 --password-stdin $3
      
      # Deploy stack with registry auth
      echo "Deploying stack..."
      docker stack deploy --with-registry-auth -c docker-compose.prod.yml myapp
      
      # Wait for services to start
      echo "Waiting for services to start..."
      sleep 15
      
      # Verify deployment
      echo "Verifying deployment..."
      docker service ls
      
      # Check service status
      echo "Checking service status..."
      docker service ps myapp_backend --no-trunc | head -5
      docker service ps myapp_frontend --no-trunc | head -5
      docker service ps myapp_nginx --no-trunc | head -5
      
      # Check logs if services are running
      echo "Checking backend logs..."
      docker service logs --tail 10 myapp_backend || true
      
      echo "Deployment completed!"
      EOF
    - chmod +x deploy.sh
    - scp docker-compose.prod.yml deploy.sh ${SSH_USER}@${SWARM_MANAGER}:~/
    - ssh ${SSH_USER}@${SWARM_MANAGER} "./deploy.sh $CI_REGISTRY_USER $CI_REGISTRY_PASSWORD $CI_REGISTRY"
  only:
    - main
  environment:
    name: production
