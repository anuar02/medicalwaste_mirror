# HTTPS server
server {
  listen 8443 ssl;
  server_name ${SERVER_NAME};

  ssl_certificate /etc/letsencrypt/live/${SERVER_NAME}/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/${SERVER_NAME}/privkey.pem;
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;

  # (1) optional: expose a health endpoint
  location = /health { access_log off; return 200 "healthy\n"; }

  # (2) CORS allow-list for your app origins (Capacitor & browser)
  set $cors_origin "";
  if ($http_origin = "https://localhost")         { set $cors_origin $http_origin; }
  if ($http_origin = "http://localhost")          { set $cors_origin $http_origin; }
  if ($http_origin = "capacitor://localhost")     { set $cors_origin $http_origin; }
  if ($http_origin = "https://${SERVER_NAME}")    { set $cors_origin $http_origin; }

  # (3) API
  location ^~ /api/ {
    # keep the path but strip the /api prefix
    rewrite ^/api(/.*)$ $1 break;

    # --- CORS headers on ALL responses (2xx/3xx/4xx/5xx) ---
    add_header 'Access-Control-Allow-Origin'  $cors_origin always;
    add_header 'Vary'                         'Origin'     always;
    add_header 'Access-Control-Allow-Credentials' 'true'    always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
    add_header 'Access-Control-Max-Age' '3600' always;

    # Preflight short-circuit
    if ($request_method = OPTIONS) {
      return 204;
    }

    proxy_pass http://${BACKEND_HOST}:5000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # If your backend does its own CORS by Origin, forward Origin header verbatim:
    proxy_set_header Origin $http_origin;
  }

  # (4) Frontend
  location / {
    proxy_pass http://${FRONTEND_HOST}:4000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
