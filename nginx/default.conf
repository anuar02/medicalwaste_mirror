FROM nginx:1.25

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    bash \
    netcat-openbsd \
    gettext-base \
    && rm -rf /var/lib/apt/lists/*

# Create wait-for script directly in the container
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
host="$1"\n\
port="$2"\n\
shift 2\n\
cmd="$@"\n\
\n\
until nc -z "$host" "$port"; do\n\
  >&2 echo "Service $host:$port is unavailable - sleeping"\n\
  sleep 1\n\
done\n\
\n\
>&2 echo "Service $host:$port is up - executing command"\n\
exec $cmd' > /wait-for.sh && chmod +x /wait-for.sh

# Create Nginx config directly
RUN echo 'server {\n\
    listen 80;\n\
    server_name localhost;\n\
\n\
    # Increase timeout for Docker Swarm network\n\
    proxy_connect_timeout 300s;\n\
    proxy_send_timeout 300s;\n\
    proxy_read_timeout 300s;\n\
    \n\
    # Enable compression\n\
    gzip on;\n\
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;\n\
\n\
    # API requests\n\
    location /api/ {\n\
        proxy_pass http://${BACKEND_HOST}:5000/;\n\
        proxy_http_version 1.1;\n\
        proxy_set_header Upgrade $http_upgrade;\n\
        proxy_set_header Connection "upgrade";\n\
        proxy_set_header Host $host;\n\
        proxy_set_header X-Real-IP $remote_addr;\n\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
        proxy_set_header X-Forwarded-Proto $scheme;\n\
        proxy_cache_bypass $http_upgrade;\n\
    }\n\
\n\
    # Frontend\n\
    location / {\n\
        proxy_pass http://${FRONTEND_HOST}:4000;\n\
        proxy_http_version 1.1;\n\
        proxy_set_header Upgrade $http_upgrade;\n\
        proxy_set_header Connection "upgrade";\n\
        proxy_set_header Host $host;\n\
        proxy_set_header X-Real-IP $remote_addr;\n\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
        proxy_set_header X-Forwarded-Proto $scheme;\n\
        proxy_cache_bypass $http_upgrade;\n\
    }\n\
\n\
    # Health check endpoint\n\
    location /health {\n\
        access_log off;\n\
        return 200 "healthy\\n";\n\
    }\n\
}' > /etc/nginx/conf.d/default.conf

# Create entrypoint script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# Replace environment variables in the nginx config\n\
envsubst \047${FRONTEND_HOST} ${BACKEND_HOST}\047 < /etc/nginx/conf.d/default.conf > /etc/nginx/conf.d/default.conf.tmp\n\
mv /etc/nginx/conf.d/default.conf.tmp /etc/nginx/conf.d/default.conf\n\
\n\
# Wait for frontend and backend services to be available\n\
echo "Waiting for frontend service..."\n\
/wait-for.sh ${FRONTEND_HOST} 4000 -t 60\n\
\n\
echo "Waiting for backend service..."\n\
/wait-for.sh ${BACKEND_HOST} 5000 -t 60\n\
\n\
# Start nginx\n\
echo "Starting Nginx..."\n\
exec "$@"' > /docker-entrypoint-custom.sh && chmod +x /docker-entrypoint-custom.sh

ENTRYPOINT ["/docker-entrypoint-custom.sh"]
CMD ["nginx", "-g", "daemon off;"]